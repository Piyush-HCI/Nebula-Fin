<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula Fin Dashboard | Portfolio Showcase</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* BASE STYLES */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d18; /* Near-Black for High Contrast */
            color: #ffffff;
            overflow-x: hidden;
            padding-bottom: 100px; /* Space for fixed bottom bar */
        }

        /* 1. Deep Cosmic Violet Background (The Nebula) */
        .cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(circle at 50% 20%, rgba(109, 40, 217, 0.2) 0%, transparent 60%), /* Violet */
                        radial-gradient(circle at 80% 60%, rgba(6, 214, 160, 0.1) 0%, transparent 50%); /* Teal */
            animation: cosmicPulse 10s ease-in-out infinite alternate;
        }
        @keyframes cosmicPulse {
            from { opacity: 0.8; transform: scale(1); }
            to { opacity: 1; transform: scale(1.1); }
        }

        /* 2. Glassmorphism (Data Cards) */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(24px); 
            border: 1px solid rgba(139, 92, 246, 0.2); 
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
        }

        /* 3. Neumorphism (Trade Buttons - Tactile) */
        .neuro-button {
            background-color: #0d0d18;
            border-radius: 12px;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.7),
                        -5px -5px 10px rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            border: none;
        }

        /* 4. Claymorphism (AI Chat FAB - Approachable) */
        .clay-fab {
            background: #06d6a0; 
            border-radius: 9999px; 
            box-shadow: 0 15px 30px rgba(6, 214, 160, 0.4), 
                        inset 0 -5px 15px rgba(0, 0, 0, 0.2), 
                        inset 0 5px 15px rgba(255, 255, 255, 0.2); 
            transition: transform 0.3s ease-out;
            cursor: pointer;
            border: none;
        }

        .clay-fab:hover {
            transform: scale(1.05);
        }
        
        /* 5. SPLASH SCREEN STYLES */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0d0d18;
            z-index: 50; /* Highest layer */
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        /* Custom spinner for loading indicator */
        .loader {
            border: 4px solid rgba(139, 92, 246, 0.3); 
            border-top: 4px solid #06d6a0; 
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Logo specific styling for glow */
        .logo-glow {
            filter: drop-shadow(0 0 10px rgba(6, 214, 160, 0.6)) drop-shadow(0 0 20px rgba(139, 92, 246, 0.4));
        }

        /* Utility for fade-in effect on main content */
        .content-fade-in {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        /* Chat Modal Animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        
        /* Custom Scrollbar for Chat History */
        #chatHistory::-webkit-scrollbar {
            width: 8px;
        }
        #chatHistory::-webkit-scrollbar-thumb {
            background-color: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }
        #chatHistory::-webkit-scrollbar-track {
            background: transparent;
        }

    </style>
</head>
<body>
    
    <!-- SPLASH SCREEN LAYER --><div id="splash-screen">
        <div class="splash-container">
            <!-- Your Chosen Quantum Coin Logo --><img src="Logo.png" alt="Nebula Fin Logo" class="h-40 w-40 mx-auto logo-glow"> 
            <h1 class="text-3xl font-extrabold mt-6 text-white tracking-wider">NEBULA FIN</h1>
            <div class="loader"></div>
        </div>
    </div>

    <!-- MAIN DASHBOARD CONTENT (Initially Hidden) --><div id="main-content" class="relative z-10 max-w-lg mx-auto p-4 space-y-4 content-fade-in">
        
        <!-- Cosmic Background (Kept outside main-content for fixed position) --><div class="cosmic-bg"></div>

        <!-- Header & Top Metrics --><header class="pt-4 flex justify-between items-center">
            <h1 class="text-xl font-extrabold text-white">NEBULA FIN</h1>
            <button class="text-gray-400 hover:text-white transition duration-200 p-2 rounded-full hover:bg-white/10">
                <!-- User Icon for Profile/Low-Frequency Actions --><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </button>
        </header>

        <!-- A. PRIMARY FOCUS AREA: Portfolio Value & AI Alert --><div class="flex flex-col gap-4">

            <!-- Main Portfolio Value (Static Glass Card) --><div class="glass-card p-6 text-center">
                <p class="text-sm font-medium text-gray-300">Total Portfolio Value</p>
                <h2 id="portfolioValue" class="text-5xl font-extrabold mb-1 mt-1 text-white">
                    $12,450.78
                </h2>
                <div id="plPercentage" class="text-lg font-semibold text-green-400">
                    +3.45% Today
                </div>
                <!-- Portfolio Analysis Button (Gemini LLM Feature 2) --><button onclick="analyzePortfolio()" id="analyzeBtn" class="mt-4 w-full neuro-button text-sm py-2 px-4 rounded-xl text-violet-300 hover:text-white transition-all flex items-center justify-center space-x-2 border border-violet-700/50">
                    <svg class="w-4 h-4 text-violet-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m7 0h3m-3 0h-3m3 0V5m0 14V5m0 0a2 2 0 012-2h2a2 2 0 012 2v14m-12 0h12"/></svg>
                    <span class="font-semibold">✨ Deep Dive Analysis</span>
                </button>
                <div id="analysisOutput" class="mt-4 text-left text-sm text-gray-300 hidden"></div>
            </div>

            <!-- AI Risk Alert Card (Glass Card) --><div class="glass-card p-4 flex justify-between items-start">
                <div>
                    <div class="flex items-center space-x-2 mb-1">
                        <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
                        <h3 class="text-xs font-bold text-yellow-400 uppercase">AI Risk Alert</h3>
                    </div>
                    <p id="alertContent" class="text-sm text-gray-200 transition-opacity duration-300">
                        Market volatility is spiking above 80% due to BTC/ETH correlation.
                    </p>
                </div>
                <!-- Customization button --><button onclick="swapAlert()" class="text-gray-500 hover:text-teal-400 transition p-1 rounded-full">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.4-1.09-.77-1.71-1.03L15 2.1c-.05-.23-.25-.37-.48-.37h-4c-.23 0-.43.14-.48.37L9.25 4.75c-.62.26-1.19.63-1.71 1.03l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.31.61.22l2.49-1c.52.4 1.09.77 1.71 1.03L9.25 21.9c.05.23.25.37.48.37h4c.23 0 .43-.14.48-.37l.82-2.58c.62-.26 1.19-.63 1.71-1.03l2.49 1c-.22.09-.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1-65zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
                </button>
            </div>
        </div>
        
        <!-- B. VISUALIZATION AREA (Asset Allocation) --><div class="glass-card p-6 flex flex-col">
            
            <!-- Header --><div class="mb-6">
                <h3 class="text-xl font-bold text-white">Asset Allocation</h3>
                <p class="text-sm text-gray-400">Portfolio Distribution</p>
            </div>
            
            <!-- Donut Chart --><div class="relative flex justify-center items-center h-48 mb-8">
                <svg width="240" height="240" viewBox="0 0 240 240" class="transform -rotate-90 donut-shadow">
                    <!-- Total Circumference: 502.65 --><!-- 1. Violet BTC Segment (60% -> 301.59 length) --><circle cx="120" cy="120" r="80" fill="none" stroke="#8b5cf6" stroke-width="40" 
                            stroke-dasharray="301.59 502.65" class="donut-segment"/>
                    
                    <!-- 2. Teal ETH Segment (25% -> 125.66 length) --><circle cx="120" cy="120" r="80" fill="none" stroke="#06d6a0" stroke-width="40" 
                            stroke-dasharray="125.66 502.65" stroke-dashoffset="-301.59" class="donut-segment"/>
                    
                    <!-- 3. Stablecoins Segment (10% -> 50.26 length) - Cyan for distinction --><circle cx="120" cy="120" r="80" fill="none" stroke="#06b6d4" stroke-width="40" 
                            stroke-dasharray="50.26 502.65" stroke-dashoffset="-427.25" class="donut-segment"/> 
                    
                    <!-- 4. Alts/DeFi Segment (5% -> 25.13 length) - Gray for high-risk/long-tail assets --><circle cx="120" cy="120" r="80" fill="none" stroke="#4b5563" stroke-width="40" 
                            stroke-dasharray="25.13 502.65" stroke-dashoffset="-477.51" class="donut-segment"/>
                    
                    </svg>
            </div>

            <!-- SPACIOUS LEGEND --><div class="grid grid-cols-2 gap-y-6 gap-x-8 text-sm">
                
                <!-- 1. BTC (60%) --><div class="flex items-center justify-between border-b border-white/5 pb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-violet-500 shadow-lg shadow-violet-500/30"></div>
                        <span class="text-gray-200 font-medium">Bitcoin (BTC)</span>
                    </div>
                    <span class="font-extrabold text-violet-300 text-lg">60%</span>
                </div>

                <!-- 2. ETH (25%) --><div class="flex items-center justify-between border-b border-white/5 pb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-teal-500 shadow-lg shadow-teal-500/30"></div>
                        <span class="text-gray-200 font-medium">Ethereum (ETH)</span>
                    </div>
                    <span class="font-extrabold text-teal-300 text-lg">25%</span>
                </div>
                
                <!-- 3. Stablecoins (10%) --><div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-cyan-500"></div>
                        <span class="text-gray-300">Stablecoins</span>
                    </div>
                    <span class="font-semibold text-gray-400">10%</span>
                </div>

                <!-- 4. Alts/DeFi (5%) --><div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-gray-600"></div>
                        <span class="text-gray-300">Alts/DeFi</span>
                    </div>
                    <span class="font-semibold text-gray-400">5%</span>
                </div>
            </div>
            <!-- End SPACIOUS LEGEND --></div>

        <!-- D. MARKET MOVERS CARD: Quick Market Overview --><div class="glass-card p-6 flex flex-col">
            <h3 class="text-xl font-bold text-white mb-4">Top Market Movers</h3>
            <p class="text-sm text-gray-400 mb-4">AI-curated list of high-momentum assets.</p>

            <div class="space-y-3">
                <!-- Mover Item 1 (Strong Gainer - Teal) --><div class="flex justify-between items-center text-sm">
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-teal-400">UNI</span>
                        <span class="text-xs text-gray-500">Uniswap</span>
                    </div>
                    <div class="text-right">
                        <span class="font-semibold text-teal-400">+12.4%</span>
                        <span class="block text-xs text-gray-300">$11.85</span>
                    </div>
                </div>

                <!-- Mover Item 2 (Moderate Gainer - Green) --><div class="flex justify-between items-center text-sm">
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-green-400">ADA</span>
                        <span class="text-xs text-gray-500">Cardano</span>
                    </div>
                    <div class="text-right">
                        <span class="font-semibold text-green-400">+3.1%</span>
                        <span class="block text-xs text-gray-300">$0.38</span>
                    </div>
                </div>

                <!-- Mover Item 3 (Moderate Loser - Red) --><div class="flex justify-between items-center text-sm">
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-red-400">DOT</span>
                        <span class="text-xs text-gray-500">Polkadot</span>
                    </div>
                    <div class="text-right">
                        <span class="font-semibold text-red-400">-2.9%</span>
                        <span class="block text-xs text-gray-300">$6.12</span>
                    </div>
                </div>

                <!-- Mover Item 4 (Stable - Gray) --><div class="flex justify-between items-center text-sm">
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-gray-400">MATIC</span>
                        <span class="text-xs text-gray-500">Polygon</span>
                    </div>
                    <div class="text-right">
                        <span class="font-semibold text-gray-400">-0.2%</span>
                        <span class="block text-xs text-gray-300">$0.81</span>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- End MAIN DASHBOARD CONTENT -->

    <!-- E. ACTION LAYER (Fixed Bottom Bar & FAB) --><div id="action-layer" class="fixed bottom-0 left-0 right-0 z-20 p-4 bg-gradient-to-t from-black to-black/80 content-fade-in">
        <div class="flex gap-4 max-w-lg mx-auto">
            <!-- Buy Button --><button class="neuro-button flex-1 py-4 rounded-xl font-bold text-lg text-white bg-green-600 hover:bg-green-700 transition-colors">
                BUY
            </button>
            
            <!-- Sell Button --><button class="neuro-button flex-1 py-4 rounded-xl font-bold text-lg text-white bg-red-600 hover:bg-red-700 transition-colors">
                SELL
            </button>
        </div>
    </div>

    <!-- AI Chat FAB (Claymorphism) --><button id="chat-fab" onclick="toggleModal()" class="clay-fab fixed bottom-20 right-6 w-14 h-14 flex items-center justify-center z-30 content-fade-in">
        <!-- Chat Icon (Simple SVG) --><svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
        </svg>
    </button>

    <!-- Chat Modal Overlay --><div id="chatModal" class="fixed inset-0 z-40 bg-black/60 hidden justify-center items-end p-4 md:items-center">
        <!-- Modal Content Container --><div class="glass-card p-6 m-4 w-full max-w-lg rounded-2xl animate-fade-in-up flex flex-col max-h-[90%]">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2 flex-shrink-0">
                <h3 class="text-xl font-bold text-teal-400">AI Trading Consultant</h3>
                <button onclick="toggleModal()" class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-white/10">
                    <!-- Close Icon --><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            
            <!-- Chat History Area --><div id="chatHistory" class="flex-grow overflow-y-auto space-y-4 mb-4 pr-2">
                <!-- Initial Message (System/Welcome) --><div class="bg-violet-900/30 p-4 rounded-lg self-start">
                    <p class="text-sm">Hello! I'm your **AI Trading Consultant**. Ask me about market news, portfolio concepts, or technical terms. I use Google Search for up-to-date data.</p>
                </div>
                </div>

            <!-- Input Area --><div class="flex-shrink-0 space-y-2">
                <div id="chatLoader" class="text-teal-400 text-sm hidden items-center justify-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-teal-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Processing...
                </div>
                <input type="text" id="chatInput" placeholder="Ask a question..." 
                        class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-sm focus:outline-none focus:border-teal-400 transition-colors text-white"
                        onfocus="this.style.backgroundColor='#0d0d18'" onblur="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'"
                        onkeydown="if(event.key === 'Enter') document.getElementById('sendBtn').click()">
                <button onclick="sendChatMessage()" id="sendBtn" class="w-full bg-teal-600 py-3 rounded-lg font-semibold hover:bg-teal-500 transition-colors">
                    Send Query
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- GEMINI API CONFIGURATION ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const API_KEY = ""; 
        const SYSTEM_PROMPT_CONSULTANT = "You are a highly responsive, world-class financial analysis chatbot named 'AI Trading Consultant'. Your goal is to provide concise, factual, and helpful information to a crypto investor. Format your answers clearly, using Markdown. Use Google Search grounding for any request involving real-time data, definitions, or recent news.";
        const SYSTEM_PROMPT_ANALYSIS = "You are a senior financial analyst writing a brief internal memo. Provide a concise, professional two-paragraph analysis of the provided cryptocurrency portfolio data. The first paragraph must discuss the current risk profile based on allocation. The second paragraph must suggest one specific, immediate action to optimize risk-adjusted returns and a brief justification. Do not use conversational language or pleasantries.";
        let currentValue = 12450.78; 

        // --- CORE APPLICATION LIFECYCLE (SPLASH SCREEN LOGIC) ---
        document.addEventListener('DOMContentLoaded', () => {
            const splashScreen = document.getElementById('splash-screen');
            const mainContent = document.getElementById('main-content');
            const actionLayer = document.getElementById('action-layer');
            const chatFab = document.getElementById('chat-fab');
            const DURATION = 5000; // 5 seconds for splash screen

            // Hide main content elements initially
            mainContent.style.display = 'none';
            actionLayer.style.display = 'none';
            chatFab.style.display = 'none';

            setTimeout(() => {
                // 1. Start the fade out of the splash screen
                splashScreen.style.opacity = '0'; 

                setTimeout(() => {
                    // 2. Hide the splash screen completely after fade-out (1s)
                    splashScreen.style.display = 'none';

                    // 3. Display main content elements
                    mainContent.style.display = 'block';
                    actionLayer.style.display = 'block';
                    chatFab.style.display = 'flex'; // FAB uses flex layout

                    // 4. Trigger the fade-in of the main content
                    // Use a short timeout to ensure the display change registers before starting opacity transition
                    setTimeout(() => {
                        mainContent.style.opacity = '1';
                        actionLayer.style.opacity = '1';
                        chatFab.style.opacity = '1';
                    }, 50);

                }, 1000); 
            }, DURATION);
        });
        
        // --- API CALL FUNCTION ---
        async function callGeminiApi(userQuery, systemPrompt, useGrounding = false) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }
            
            for (let attempt = 0; attempt < 4; attempt++) {
                try {
                    const response = await fetch(API_URL + API_KEY, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (response.status === 429 && attempt < 3) {
                        const delay = Math.pow(2, attempt) * 1000; await new Promise(resolve => setTimeout(resolve, delay)); continue;
                    }
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions.map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title, })).filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    }
                    return { text: "Sorry, I couldn't generate a response. Please try rephrasing your query.", sources: [] };
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt < 3) { const delay = Math.pow(2, attempt) * 1000; await new Promise(resolve => setTimeout(resolve, delay)); }
                }
            }
            return { text: "API request failed after multiple retries. Please check your network or try again later.", sources: [] };
        }

        // --- CHAT INTERFACE FUNCTIONS ---
        function createMessageElement(text, isUser, sources = []) {
            const div = document.createElement('div');
            const roleClass = isUser ? 'bg-teal-700/50 self-end ml-auto' : 'bg-violet-900/30 self-start mr-auto';
            
            let htmlContent = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            htmlContent = htmlContent.replace(/\n/g, '<br>');

            div.className = `p-4 rounded-xl max-w-[90%] ${roleClass}`;
            div.innerHTML = `<p class="text-sm">${htmlContent}</p>`;

            if (sources.length > 0) {
                let sourcesHtml = '<div class="mt-3 pt-2 border-t border-white/20 text-xs text-gray-400">';
                sourcesHtml += '<strong>Sources:</strong><ul>';
                sources.slice(0, 2).forEach((source) => {
                     sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-teal-400 hover:text-teal-300 transition-colors truncate block" title="${source.title}">${source.title}</a></li>`;
                });
                sourcesHtml += '</ul></div>';
                div.innerHTML += sourcesHtml;
            }
            return div;
        }

        async function sendChatMessage() {
            const inputElement = document.getElementById('chatInput');
            const chatHistory = document.getElementById('chatHistory');
            const loader = document.getElementById('chatLoader');
            const userQuery = inputElement.value.trim();

            if (!userQuery) return;

            chatHistory.appendChild(createMessageElement(userQuery, true));
            inputElement.value = '';
            inputElement.disabled = true;
            chatHistory.scrollTop = chatHistory.scrollHeight;

            loader.classList.remove('hidden'); loader.classList.add('flex');

            const result = await callGeminiApi(userQuery, SYSTEM_PROMPT_CONSULTANT, true);

            loader.classList.add('hidden'); loader.classList.remove('flex');
            inputElement.disabled = false;
            
            chatHistory.appendChild(createMessageElement(result.text, false, result.sources));
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // --- PORTFOLIO ANALYSIS FUNCTION ---
        async function analyzePortfolio() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analysisOutput = document.getElementById('analysisOutput');
            
            const analysisQuery = `As a senior financial analyst, provide a concise, professional two-paragraph analysis of a cryptocurrency portfolio with a total value of $${currentValue.toFixed(2)}, allocated as 60% Bitcoin (BTC), 25% Ethereum (ETH), 10% Stablecoins, and 5% Altcoins/DeFi. The first paragraph must discuss the current risk profile based on this allocation (BTC dominance vs. the Stablecoin/Altcoin diversification). The second paragraph must suggest one specific, immediate action to optimize risk-adjusted returns (e.g., rebalancing, new asset class) and a brief justification.`;

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="font-semibold">Generating Analysis...</span>`;
            analysisOutput.classList.remove('hidden');
            analysisOutput.innerHTML = '<p class="text-gray-500">Awaiting deep dive report...</p>';

            const result = await callGeminiApi(analysisQuery, SYSTEM_PROMPT_ANALYSIS, false);

            let formattedText = result.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\n\n/g, '<br><br>');
            formattedText = formattedText.replace(/\n/g, '<br>');

            analysisOutput.innerHTML = `<h4 class="font-bold text-violet-300 mb-1">Portfolio Summary (Generated)</h4><div class="p-3 bg-white/5 rounded-lg border border-violet-500/30 text-xs leading-relaxed">${formattedText}</div>`;
            
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `<svg class="w-4 h-4 text-violet-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m7 0h3m-3 0h-3m3 0V5m0 14V5m0 0a2 2 0 012-2h2a2 2 0 012 2v14m-12 0h12"/></svg><span class="font-semibold">✨ Deep Dive Analysis</span>`;
        }

        // --- UI LOGIC ---
        function swapAlert() {
            const alertContent = document.getElementById('alertContent');
            const alerts = [
                "Market volatility is spiking above 80% due to BTC/ETH correlation.",
                "Unusual whale activity detected in BTC markets. Consider portfolio rebalancing.",
                "Strong support level identified at $12,200. Risk assessment: LOW.",
                "Regulatory clarity is incoming for stablecoins; positive outlook for DeFi assets."
            ];
            let alertIndex = (alerts.indexOf(alertContent.textContent) + 1) % alerts.length;
            
            alertContent.classList.add('opacity-0');
            
            setTimeout(() => {
                alertContent.textContent = alerts[alertIndex];
                alertContent.classList.remove('opacity-0');
            }, 300); 
        }

        function toggleModal() {
            const modal = document.getElementById('chatModal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
            
            if (modal.classList.contains('flex')) {
                const modalContent = modal.querySelector('.glass-card');
                modalContent.classList.add('animate-fade-in-up');
                setTimeout(() => {
                    modalContent.classList.remove('animate-fade-in-up');
                }, 500);
                document.getElementById('chatInput').focus();
            }
        }

        document.getElementById('chatModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleModal();
            }
        });

        document.querySelectorAll('.neuro-button').forEach(button => {
            const originalShadow = button.style.boxShadow;
            
            button.addEventListener('mousedown', () => {
                button.style.boxShadow = 'inset 3px 3px 6px rgba(0, 0, 0, 0.8), inset -3px -3px 6px rgba(255, 255, 255, 0.03)';
                button.style.transform = 'scale(0.98)';
                button.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            });
            
            button.addEventListener('mouseup', () => {
                setTimeout(() => {
                    button.style.boxShadow = originalShadow;
                    button.style.transform = 'scale(1)';
                    button.style.backgroundColor = '';
                }, 100);
            });
            
            button.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                button.style.boxShadow = 'inset 3px 3px 6px rgba(0, 0, 0, 0.8), inset -3px -3px 6px rgba(255, 255, 255, 0.03)';
                button.style.transform = 'scale(0.98)';
                button.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            });
            
            button.addEventListener('touchend', () => {
                 setTimeout(() => {
                    button.style.boxShadow = originalShadow;
                    button.style.transform = 'scale(1)';
                    button.style.backgroundColor = '';
                }, 100);
            });
        });
    </script>
</body>
</html>
